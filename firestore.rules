rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Allow authenticated users to read all posts
    match /posts/{document=**} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.authorId
        || (
          request.auth != null &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['commentCount']) &&
          (
            (
              request.resource.data.commentCount ==
              ((resource.data.commentCount == null ? 0 : resource.data.commentCount) + 1)
            ) ||
            (resource.data.commentCount == null && request.resource.data.commentCount == 1)
          )
        );

      // Replies on posts
      match /comments/{commentId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
        allow update, delete: if request.auth != null && request.auth.uid == resource.data.authorId;
      }
    }

    // Clubs catalog
    match /clubs/{clubId} {
      allow read: if request.auth != null;
      allow create, update, delete: if false; // managed via backend only
    }

    // User club memberships
    match /club_members/{membershipId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
      allow update: if false;
    }

    // Events catalog
    match /events/{eventId} {
      allow read: if request.auth != null;
      allow create, update, delete: if false; // backend/admin only
    }

    // User profiles (editable by owner only)
    match /profiles/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        request.auth.uid == userId ||
        (
          // Allow follower/following count adjustments of +/-1 by authenticated users
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['followerCount']) &&
          (
            request.resource.data.followerCount == (resource.data.followerCount ?? 0) + 1 ||
            request.resource.data.followerCount == (resource.data.followerCount ?? 0) - 1
          )
        )
      );
    }

    // Followers: followers/{userId}/users/{followerId}
    match /followers/{userId}/users/{followerId} {
      allow read: if request.auth != null;
      allow create, delete: if request.auth != null && request.auth.uid == followerId;
      allow update: if false;
    }

    // Following: following/{userId}/users/{followingId}
    match /following/{userId}/users/{followingId} {
      allow read: if request.auth != null;
      allow create, delete: if request.auth != null && request.auth.uid == userId;
      allow update: if false;
    }
  }
}
